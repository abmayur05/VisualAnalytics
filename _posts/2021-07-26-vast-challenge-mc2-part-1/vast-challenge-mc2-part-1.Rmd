---
title: "VAST Challenge MC2 - Part 1"
description: |
  This post presents the step by step instructions that were followed to identify which GASTech employess made which purchases and identify suspicious patterns of behavior using visual analytic techniques.
author:
  - name: Mayurapriyann Arulmozhi Baskaran
    url: https://www.linkedin.com/in/mayurapriyann/
date: 07-25-2021
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_float: true
    smooth_scroll: true
    theme: united
    highlight: tango
preview: 1.jpg
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, error=FALSE)
```

# Overview

Tethys-based GAStech has been operating a natural gas production site in the island country of Kronos for the past twenty years. The company has produced remarkable profits and developed strong relationships with the government of Kronos. However, GAStech has not been successful in demonstrating environmental stewardship.

In January 2014, the leaders of GAStech are celebrating their newfound fortune as a result of the initial public offering of their very successful company. In the midst of this celebration, several employees of GAStech go missing. An organization known as the Protectors of Kronos (POK) is suspected of the disappearance.

# Objective

Most of the employees of GAStech are provided with company cars approved for both personal and business use. Those who do not have company cars are given access to company trucks, but these cannot be used for personal use. 

The company cars are of much higher quality than the cars the employees would be able to afford otherwise. However, GAStech has installed geospatial tracking software in the company vehicles to track the movements periodically. The vehicle data is available for two weeks prior to the disappearance. 

In addition to the geospatial data, Kronos-based companies provide a benefits card giving the employees discounts and rewards in exchange for collecting the credit card purchases and preferences. The objective of the analysis is to identify suspicious patterns of behavior of the employees to make recommendations for further investigation.

In January 2014, the leaders of GAStech are celebrating their newfound fortune as a result of the initial public offering of their very successful company. In the midst of this celebration, several employees of GAStech go missing. An organization known as the Protectors of Kronos (POK) is suspected of the disappearance.

# Literature review

Literature review was conducted to analyze how the various analyses with similar objectives had been performed earlier and whether those techniques used in the past are applicable to this assignment with/without enhancements.  Also, the issues identified in the previous analyses were also discussed and alternative approaches are provided to overcome those issues. The mini-challenge published in the year 2014 was similar hence a few of those submissions were reviewed before starting this assignment.

1. In the submission by Middlesex University, the credit card and loyalty card usage by the employees of GASTech was visualized by 3D bar plot and it can be inferred that truck drivers tend to spend the most compared to the other employees but it is always advisable to avoid using 3D effects unless we have three-dimensional data. Clear visualizations can be achieved by using interactive 2D plots. Most of the analyses have been performed by custom-made analytical tools which are not accessible by the general public. Hence this assignment is built on R packages to cater wide segment of the audience mainly due to script reproducibility.
2. In the submission by KU Leven University, the daily routine is interestingly visualized by grouping it according to the department type and further faceted by day of the month. A box plot is utilized to find the outliers present for all the locations where the credit cards are used. Though it is spaced perfectly to get a clear view, we were not able to pinpoint the location of the outlier quickly as there are many locations. To overcome this issue, in our assignment I have added interactivity by adding the tooltip so by just hovering the mouse cursor on the outliers shows the corresponding location where the transaction had taken place and in addition to this, other details such as minimum, 25th percentile, median, 75th percentile, maximum values can also be found.
3. In the submission by the University of Buenos Aires,  a heat map is used to visualize the credit card data per hour with sequential colors to find out the abnormalities, though it is visually appealing to find the abnormalities, the exact number of transactions cannot be got from the plot. This issue can be overcome by adding interactivity to the heat map so that the count of the transactions can be known via tooltips just hovering the cursor over the specific points.

# Building the visualization

## Task 1
**Using just the credit and loyalty card data, identify the most popular locations, and when they are popular. What anomalies do you see? What corrections would you recommend to correct these anomalies?**

All the data extraction, wrangling and preparing the input data required to perform the analysis are done in R using appropriate packages.

*Setting up the environment*

Firstly, it is important to install the necessary R packages and launch them into R Studio environment. The below code chunk checks for the available packages and installs those packages that are not available. In-addition to that, all those packages will be launched into RStudio environment.

raster - To read, write, manipulate, analyze, model spatial data <br>
sf - To support simple features and encode spatial vector data <br>
tmap - To visualize spatial data distributions <br>
tidyverse - A opinionated collection of R packages for data science <br>
clock - Provides a comprehensive library for date-time manipulations <br>
rgdal - Works on both raster and vector data types for manipulating geospatial data <br>
tidytext - Makes text mining tasks easier, more effective and consistent <br>
widyr - To widen the matrix, perform some processing, then turn back to tidy form <br>
DT - To render data objects as HTML tables using JavaScript library <br>
dplyr - A fast, consistent tool for working with data frame like objects <br>
hms - To store and format time-of-day values <br>
ggraph - An extension of ggplot2 for graph and network visualizations<br>
igraph - For simple graphs and network analysis <br>
crosstalk - To support linked brushing and filtering <br>
plotly - To create interactive web graphics and custom interface <br>
data.table - To handle data sets in R <br>
stringi - For fast, correct, consistent, and convenient string/text manipulation <br>
mapview - To create interactive visualizations of spatial data <br>
ggridges - Used for visualizing changes in distributions over time <br>
networkD3 - To create interactive network graphs with JavaScript <br>
htmlwidgets - A framework for creating HTML widgets in R console <br>

```{r}
packages = c('raster','sf','tmap','tidyverse','clock','rgdal','tidytext','widyr',
             'DT','dplyr','hms','ggraph','igraph','crosstalk',
             'plotly','data.table','stringi','mapview','ggridges','networkD3',
             'htmlwidgets')

for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```

*Reading the credit card and loyalty card details*

Importing credit card and loyalty card details into two separate data frames.

```{r}
cc <- read_csv(file = 'data/cc_data.csv')

lc <- read_csv(file = 'data/loyalty_data.csv')
```

*Renaming foreign characters*

A single value under the location column has a non-english character hence replacing the foreign character with alternative english character.

```{r}
setDT(cc)[location %like% "^Katerina", location := "Katerina's Cafe"]
setDT(lc)[location %like% "^Katerina", location := "Katerina's Cafe"]
```

View the columns of the dataset and their respective attributes.

```{r}
glimpse(cc)
glimpse(lc)
```
*Changing data type and extracting new columns*

It can be seen that the timestamp column is in character datatype. Hence, it is converted to timestamp format. After which day, hour and day of the week are extracted from the timestamp column. In addition, the 'last4ccnum' column in the credit card dataset is changed from integer format to character format.

```{r}
cc$timestamp <- date_time_parse(cc$timestamp,
                                zone = "",
                                format = "%m/%d/%Y %H:%M")

lc$timestamp <- date_time_parse(lc$timestamp,
                                zone = "",
                                format = "%m/%d/%Y")


cc <- cc %>%
  mutate(day = get_day(timestamp),
         hour = get_hour(timestamp),
         date = as_date(timestamp))

lc <- lc %>%
  mutate(day = get_day(timestamp))


cc$dayofweek <- weekdays(cc$timestamp)

lc$dayofweek <- weekdays(lc$timestamp)

cc$last4ccnum <- as.character(cc$last4ccnum)
```

*Getting a glimpse after change*

View the columns of the dataset and their respective attributes after pre-processing.

```{r}
glimpse(cc)
glimpse(lc)
```
Usually, the loyalty cards are used along with the credit cards to get some discounts and rewards but there is a mismatch between the total number of records between the credit card transactions (1490) and loyalty card transactions (1392). 

Getting the count of transactions made by the employees with credit cards and loyalty cards in order to find the most frequented and least frequented locations.

```{r}
cc_bar <- cc %>%
  count(location, sort=TRUE)

lc_bar <- lc %>%
  count(location, sort=TRUE)
```

*Plotting the most frequented and least frequented locations*

```{r, layout="l-page", fig.width=8, fig.height=6, fig.align='center'}
fig <- plot_ly(cc_bar, x = ~location, y = ~n, type = 'bar', hoverinfo="text", text = ~paste(location,'</br></br>', n),
               marker = list(color = ~n,
                             colorbar = list(title = 'Visits'))) %>%
  layout(title = "Popular locations by credit card transactions",
         xaxis = list(title = "Location", categoryarray = ~location, categoryorder = "array", tickangle                = 270),
         yaxis = list(title = "Visits"))
fig
```

```{r, layout="l-page", fig.width=8, fig.height=6, fig.align='center'}
fig <- plot_ly(lc_bar, x = ~location, y = ~n, type = 'bar', hoverinfo="text", text = ~paste(location,'</br></br>', n),
               marker = list(color = ~n,
                             colorbar = list(title = 'Visits'))) %>%
  layout(title = "Popular locations by loyalty card transactions",
         xaxis = list(title = "Location", categoryarray = ~location, categoryorder = "array", tickangle                = 270),
         yaxis = list(title = "Visits")) 
fig
```

By comparing both the bar plots by credit card and loyalty card transactions, the most popular locations are identified as Katerina's Cafe, Hippokampos, Guy's Gyros and Brew've Been Served. The fifth popular location is Hallowed Grounds according to the number of transactions made by credit card. But there is some anomaly in the usage of loyalty cards in this location as there are mismatches in total credit card transactions and total loyalty card transactions. The total number of credit card transactions in this location is 92 but the total number of loyalty card transactions is only 80. One suspicious transaction that can be observed from the above plot is at location Daily Dealz as there was only one recorded credit card transaction over the period of 14 days and also the loyalty card is not used in this particular location.

Now plotting a heatmap to find out the most visited and least visited locations by hour of the day.

```{r, layout="l-page", fig.width=6, fig.height=8, fig.align='center'}
cc$location <- stri_trans_general(cc$location, "latin-ascii")
x_axis_labels <- min(cc[,'hour']):max(cc[,'hour'])

p <- group_by(cc,hour,location) %>% summarize(n=n()) %>% 
  ggplot(aes(hour,location,fill=n)) + geom_tile() +
  scale_x_continuous(expand=c(0,0),labels = x_axis_labels, breaks = x_axis_labels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))+
  scale_fill_distiller(palette = "Reds", direction = 1, labels = c(0, 20, 40, 60, "> 80")) +
  labs(title = "Most/least frequented locations by hour of the day", y = "Location", x = "Hour")

ggplotly(p)
```

Hourly popularity can be inferred from the above heatmap. 

Morning 7 am - 9 am

1. Brew've Been Served
2. Hallowed Grounds
3. Coffee Cameleon <br>
The name of these locations suggests that they might serve coffee and snacks. The surge in the morning hours may indicate that the employees tend to have their breakfast/coffee at these locations before going to GASTech.

Noon 12 pm - 2 pm

1. Hippokampos
2. Katerina's Cafe
3. Abila Zachora
4. Gelatogalore
5. Guy's Gyros <br>
This might be the lunchtime for the GASTech employees. The list shows only the top 5 locations between 12 pm - 2 pm. But unlike breakfast locations which were limited to only three highly sought-after outlets, the employees tend to have various options for lunch.

Evening 7 pm - 9 pm

1. Katerina's Cafe
2. Guy's Gyros
3. Hippokampos
4. Frydos Autosupply n' More
5. Ouzeri Elian <br>
This should be the dinner time for the employees. The time period corresponding to morning and noon seem to have locations related to food and beverages. But between 7 pm - 9 pm, there seems to be some surge in visitors at Frydos Autosupply n' More.

Below is a heatmap to find out the most visited and least visited locations by day of the month.

```{r, layout="l-page", fig.width=6, fig.height=8, fig.align='center'}
cc$location <- stri_trans_general(cc$location, "latin-ascii")
x_axis_labels <- min(cc[,'day']):max(cc[,'day'])

p <- group_by(cc,day,location) %>% summarize(n=n()) %>% 
  ggplot(aes(day,location,fill=n)) + geom_tile() +
  scale_x_continuous(expand=c(0,0),labels = x_axis_labels, breaks = x_axis_labels) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))+
  scale_fill_distiller(palette = "Reds", direction = 1) +
  labs(y= "Location", x = "Day Of Month", title = "Most/least frequented locations by day of month")

ggplotly(p)
```

Over the 14 days period, places such as Katerina's Cafe, Hippokampos and Guy's Gyros are popular. One of the other popular places is Brew've Been Served but there are no transactions on both the weekends so we can infer that this outlet is closed on weekends. 

Below is a heatmap to find out the most visited and least visited locations by day of the week.

```{r, layout="l-page", fig.width=6, fig.height=8, fig.align='center'}
cc$location <- stri_trans_general(cc$location, "latin-ascii")
x_axis_labels <- min(cc[,'day']):max(cc[,'day'])

p <- group_by(cc,dayofweek,location) %>% summarize(n=n()) %>% 
  ggplot(aes(dayofweek,location,fill=n)) + geom_tile() + 
  scale_fill_distiller(palette = "Reds", limits = c(0,10), na.value = "#de2d26",
                       direction = 1, labels = c(0.0, 2.5, 5.0, 7.5, "> 10.0")) +
  labs(y= "Location", x = "Day Of Week", title = "Most/least frequented locations by day of week") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5), panel.grid.major = element_blank())

ggplotly(p)
```

Weekends usually tend to have fewer visitors compared to weekdays. And some of the outlets had no transactions made during the weekends but had a decent number of transactions during weekdays implying that few outlets may be closed on weekends.

*Joining credit card data and loyalty card data*

Using a left join to merge loyalty card data with credit card data to map all the transactions. 

```{r}
merged_cards <- left_join(cc, lc, by = c("date" = "timestamp", "location" = "location", "price" = "price"))
glimpse(merged_cards)
```
After the left join, the total number records increased from 1490 to 1496, this hows that multiple loyalty cards have been used to single credit card owners.

Below are the list of loyalty cards that were used by more than one credit card owners.

```{r}
t <- merged_cards %>% 
  na.omit() %>%
  group_by(loyaltynum) %>%
  summarise(count = n_distinct(last4ccnum))

t %>%
  filter(count>1)
```

Mapping the corresponding credit card details to the loyalty card detils and getting the number of transactions performed.

```{r}
bt <- merged_cards %>%
  filter(loyaltynum %in% c("L2070","L2247","L3288","L3295","L6119",
                           "L6267","L8566","L9406")) %>%
  group_by(last4ccnum, loyaltynum) %>%
  summarise(n=n())

bt
```

Plotting the price distribution using ridge plot to get a sense of transaction ranges at different locations. The price column is transformed to log scale to get a better visualization.

```{r, layout="l-page", fig.width=6, fig.height=5, fig.align='center'}
ggplot(data = cc, aes(x=log(cc$price+1), y=location,
                           fill = 0.5 - abs(0.5 - stat(ecdf))
                           ))+
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, gradient_lwd = 1., calc_ecdf = TRUE) +
  theme_ridges(font_size = 12, grid = FALSE)+
  scale_fill_viridis_c(name = "Tail probability", direction = -1) +
  labs(
    y= "Location",
    x = "Price (logscale)",
    title = "Price distribution by location"
  ) +
  theme(
axis.title.x = element_text(hjust = 0.5),
axis.title.y = element_text(hjust = 0.5)
)
```
This ridge plot is used to display the transaction price distribution across all the locations visited by the employees of GASTech. Transaction price is expressed in log scale for better visualization. Locations such as U-Pump, Maximum Iron and Steel, Kronos Pipe and Irrigation, Carlyle Chemical Inc., Abila Airport, Abila Scrapyard and Nationwide Refinery were the high priced transactions had taken place.

Below is a interactive data table with credit card transaction details which can be utilised at a later stage of the analysis.

```{r}
DT::datatable(cc,
              filter = 'top') %>%
  formatStyle(columns = 0,
              target = 'row',
              lineHeight = '100%') %>%
  formatDate(1, "toLocaleString")
```
A granular level information can be got by referring the interactive data table to check for any anomalies throughout this analysis.

Below is a interactive data table with credit card transaction details and loyalty card transaction details to know the credit card and loyalty card pairs that had been used together.

```{r}
DT::datatable(merged_cards,
              filter = 'top') %>%
  formatStyle(columns = 0,
              target = 'row',
              lineHeight = '100%') %>%
  formatDate(1, "toLocaleString") %>%
  formatDate(7, "toLocaleDateString")
```

The below data table shows the unique transaction and total transaction details based on the locations.

```{r}
z <- cc %>%
  group_by(location) %>%
  summarise(unique = n_distinct(last4ccnum), total=n())

DT::datatable(z,
              filter = 'top') %>%
  formatStyle(columns = 1,
              target = 'row',
              lineHeight = '100%')
```



